<!doctype html><html lang=en><head><title>Cassandra lightweight transactions mixed with ordinary queries · isopov
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Ivan Sopov"><meta name=description content='Recently I&rsquo;ve discovered that adding a simple &ldquo;if exists&rdquo; clause to query in Cassandra turns it into something completely different. Lightweight transaction is started that is not really compatible with running some data modification queries without such clause. I debugged this problem to the simple independent reproducer, so I&rsquo;d like to share it.
@Testcontainers class UpdateTest { @Container private static final CassandraContainer cassandra = (CassandraContainer) new CassandraContainer("cassandra:4.1.3").withExposedPorts(9042); private static CqlSession session; @BeforeAll static void setup() { session = CqlSession.'><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Cassandra lightweight transactions mixed with ordinary queries"><meta name=twitter:description content='Recently I’ve discovered that adding a simple “if exists” clause to query in Cassandra turns it into something completely different. Lightweight transaction is started that is not really compatible with running some data modification queries without such clause. I debugged this problem to the simple independent reproducer, so I’d like to share it.
@Testcontainers class UpdateTest { @Container private static final CassandraContainer cassandra = (CassandraContainer) new CassandraContainer("cassandra:4.1.3").withExposedPorts(9042); private static CqlSession session; @BeforeAll static void setup() { session = CqlSession.'><meta property="og:url" content="https://isopov.github.io/posts/cassandra-lwt-queries-mix/"><meta property="og:site_name" content="isopov"><meta property="og:title" content="Cassandra lightweight transactions mixed with ordinary queries"><meta property="og:description" content='Recently I’ve discovered that adding a simple “if exists” clause to query in Cassandra turns it into something completely different. Lightweight transaction is started that is not really compatible with running some data modification queries without such clause. I debugged this problem to the simple independent reproducer, so I’d like to share it.
@Testcontainers class UpdateTest { @Container private static final CassandraContainer cassandra = (CassandraContainer) new CassandraContainer("cassandra:4.1.3").withExposedPorts(9042); private static CqlSession session; @BeforeAll static void setup() { session = CqlSession.'><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-10-05T15:10:49+03:00"><meta property="article:modified_time" content="2023-10-05T15:10:49+03:00"><meta property="article:tag" content="Cassandra"><meta property="article:tag" content="Java"><link rel=canonical href=https://isopov.github.io/posts/cassandra-lwt-queries-mix/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.38c4552ac40f9ae3408bad40358f654ebd8804412fe74ed56f2d6c8a7af82dd3.css integrity="sha256-OMRVKsQPmuNAi61ANY9lTr2IBEEv507Vby1sinr4LdM=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://isopov.github.io/>isopov
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/tags/>Tags</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://isopov.github.io/posts/cassandra-lwt-queries-mix/>Cassandra lightweight transactions mixed with ordinary queries</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2023-10-05T15:10:49+03:00>October 5, 2023
</time></span><span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
2-minute read</span></div><div class=tags><i class="fa-solid fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/cassandra/>Cassandra</a>
</span><span class=separator>•</span>
<span class=tag><a href=/tags/java/>Java</a></span></div></div></header><div class=post-content><p>Recently I&rsquo;ve discovered that adding a simple &ldquo;if exists&rdquo; clause to query in Cassandra turns it into something completely different. Lightweight transaction is started that is not really compatible with running some data modification queries without such clause. I debugged this problem to the simple independent reproducer, so I&rsquo;d like to share it.</p><div class=highlight><pre tabindex=0 style=color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Testcontainers
</span></span><span style=display:flex><span><span style=color:#fff;font-weight:700>class</span> UpdateTest {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Container
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>private</span> <span style=color:#fff;font-weight:700>static</span> <span style=color:#fff;font-weight:700>final</span> CassandraContainer cassandra
</span></span><span style=display:flex><span>            = (CassandraContainer) <span style=color:#fff;font-weight:700>new</span> CassandraContainer(<span style=color:#0ff;font-weight:700>&#34;cassandra:4.1.3&#34;</span>).<span style=color:#007f7f>withExposedPorts</span>(9042);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>private</span> <span style=color:#fff;font-weight:700>static</span> CqlSession session;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @BeforeAll
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>static</span> <span style=color:#fff;font-weight:700>void</span> setup() {
</span></span><span style=display:flex><span>        session = CqlSession.<span style=color:#007f7f>builder</span>()
</span></span><span style=display:flex><span>                .<span style=color:#007f7f>addContactPoint</span>(cassandra.<span style=color:#007f7f>getContactPoint</span>())
</span></span><span style=display:flex><span>                .<span style=color:#007f7f>withLocalDatacenter</span>(<span style=color:#0ff;font-weight:700>&#34;datacenter1&#34;</span>)
</span></span><span style=display:flex><span>                .<span style=color:#007f7f>build</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        session.<span style=color:#007f7f>execute</span>(<span style=color:#0ff;font-weight:700>&#34;drop keyspace if exists updatetests&#34;</span>);
</span></span><span style=display:flex><span>        session.<span style=color:#007f7f>execute</span>(<span style=color:#0ff;font-weight:700>&#34;create keyspace updatetests with replication = {&#39;class&#39; : &#39;SimpleStrategy&#39;, &#39;replication_factor&#39; : 1}&#34;</span>);
</span></span><span style=display:flex><span>        session.<span style=color:#007f7f>execute</span>(<span style=color:#0ff;font-weight:700>&#34;use updatetests&#34;</span>);
</span></span><span style=display:flex><span>        session.<span style=color:#007f7f>execute</span>(<span style=color:#0ff;font-weight:700>&#34;drop table if exists test&#34;</span>);
</span></span><span style=display:flex><span>        session.<span style=color:#007f7f>execute</span>(<span style=color:#0ff;font-weight:700>&#34;create table test (a text, b int, primary key(a))&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @AfterAll
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>static</span> <span style=color:#fff;font-weight:700>void</span> tearDown() {
</span></span><span style=display:flex><span>        session.<span style=color:#007f7f>close</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Test
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>void</span> testLwtInsertAndLwtUpdate() {
</span></span><span style=display:flex><span>        session.<span style=color:#007f7f>execute</span>(<span style=color:#0ff;font-weight:700>&#34;insert into test(a,b) values(?,?) if not exists&#34;</span>, <span style=color:#0ff;font-weight:700>&#34;x&#34;</span>, 1);
</span></span><span style=display:flex><span>        session.<span style=color:#007f7f>execute</span>(<span style=color:#0ff;font-weight:700>&#34;update test set b=? where a=? if exists&#34;</span>, 2, <span style=color:#0ff;font-weight:700>&#34;x&#34;</span>);
</span></span><span style=display:flex><span>        assertUpdate(<span style=color:#0ff;font-weight:700>&#34;x&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Test
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>void</span> testInsertAndLwtUpdate() {
</span></span><span style=display:flex><span>        session.<span style=color:#007f7f>execute</span>(<span style=color:#0ff;font-weight:700>&#34;insert into test(a,b) values(?,?)&#34;</span>, <span style=color:#0ff;font-weight:700>&#34;y&#34;</span>, 1);
</span></span><span style=display:flex><span>        session.<span style=color:#007f7f>execute</span>(<span style=color:#0ff;font-weight:700>&#34;update test set b=? where a=? if exists&#34;</span>, 2, <span style=color:#0ff;font-weight:700>&#34;y&#34;</span>);
</span></span><span style=display:flex><span>        assertUpdate(<span style=color:#0ff;font-weight:700>&#34;y&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Test
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>void</span> testLwtInsertAndUpdate() {
</span></span><span style=display:flex><span>        session.<span style=color:#007f7f>execute</span>(<span style=color:#0ff;font-weight:700>&#34;insert into test(a,b) values(?,?) if not exists&#34;</span>, <span style=color:#0ff;font-weight:700>&#34;z&#34;</span>, 1);
</span></span><span style=display:flex><span>        session.<span style=color:#007f7f>execute</span>(<span style=color:#0ff;font-weight:700>&#34;update test set b=? where a=?&#34;</span>, 2, <span style=color:#0ff;font-weight:700>&#34;z&#34;</span>);
</span></span><span style=display:flex><span>        assertUpdate(<span style=color:#0ff;font-weight:700>&#34;z&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#fff;font-weight:700>private</span> <span style=color:#fff;font-weight:700>static</span> <span style=color:#fff;font-weight:700>void</span> assertUpdate(String id) {
</span></span><span style=display:flex><span>        <span style=color:#fff;font-weight:700>var</span> res = session.<span style=color:#007f7f>execute</span>(<span style=color:#0ff;font-weight:700>&#34;select * from test where a=?&#34;</span>, id);
</span></span><span style=display:flex><span>        res.<span style=color:#007f7f>forEach</span>(row -&gt; assertEquals(2, row.<span style=color:#007f7f>getInt</span>(<span style=color:#0ff;font-weight:700>&#34;b&#34;</span>)));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Running this sample only 2 out of 3 tests pass. <code>testInsertAndLwtUpdate</code> fails. What is even more interesting is that in my tests it reports lightweight transaction applied.</p><p>You may find full self-contained example at <a href=https://github.com/isopov/cassandra-lwt-test class=external-link target=_blank rel=noopener>my github</a>.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2011 -
2024
Ivan Sopov
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>